# Grafana Alloy - 통합 Observability 에이전트
# Promtail 대체 + 메트릭 수집

crds:
  create: true

alloy:
  configMap:
    create: true
    content: |
      // =====================================================
      // 로그 수집 (Promtail 대체)
      // =====================================================

      // Kubernetes Pod 로그 발견
      discovery.kubernetes "pods" {
        role = "pod"
      }

      // 로그 수집 대상 필터링
      discovery.relabel "pods" {
        targets = discovery.kubernetes.pods.targets

        // Running Pod만 수집
        rule {
          source_labels = ["__meta_kubernetes_pod_phase"]
          regex         = "Pending|Succeeded|Failed|Completed"
          action        = "drop"
        }

        // 네임스페이스 라벨
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }

        // Pod 이름 라벨
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }

        // 컨테이너 이름 라벨
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }

        // Job 이름 (있으면)
        rule {
          source_labels = ["__meta_kubernetes_pod_label_job_name"]
          target_label  = "job"
        }

        // App 라벨
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app"]
          target_label  = "app"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          target_label  = "app"
        }
      }

      // 로그 소스 설정
      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [loki.process.logs.receiver]
      }

      // 로그 처리 파이프라인
      loki.process "logs" {
        // 타임스탬프 추출 (JSON 로그)
        stage.json {
          expressions = {
            timestamp = "time",
            level     = "level",
          }
        }

        // 로그 레벨 라벨 추가
        stage.labels {
          values = {
            level = "",
          }
        }

        forward_to = [loki.write.loki.receiver]
      }

      // Loki로 전송
      loki.write "loki" {
        endpoint {
          url = "http://lgtm-loki-gateway.monitoring:80/loki/api/v1/push"
        }
      }

      // =====================================================
      // 메트릭 수집 (Prometheus 스타일)
      // =====================================================

      // Kubernetes 서비스 발견
      discovery.kubernetes "services" {
        role = "service"
      }

      // Kubernetes 엔드포인트 발견
      discovery.kubernetes "endpoints" {
        role = "endpoints"
      }

      // Kubernetes Pod 메트릭 발견
      discovery.kubernetes "pod_metrics" {
        role = "pod"
      }

      // kubelet 메트릭 (cAdvisor)
      discovery.kubernetes "nodes" {
        role = "node"
      }

      // ----------------------
      // kubelet/cAdvisor 메트릭
      // ----------------------
      discovery.relabel "kubelet" {
        targets = discovery.kubernetes.nodes.targets

        rule {
          target_label = "__address__"
          replacement  = "kubernetes.default.svc:443"
        }

        rule {
          source_labels = ["__meta_kubernetes_node_name"]
          regex         = "(.+)"
          target_label  = "__metrics_path__"
          replacement   = "/api/v1/nodes/$1/proxy/metrics/cadvisor"
        }
      }

      prometheus.scrape "kubelet" {
        targets         = discovery.relabel.kubelet.output
        scheme          = "https"
        scrape_interval = "60s"

        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"

        tls_config {
          ca_file              = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
          insecure_skip_verify = true
        }

        forward_to = [prometheus.remote_write.mimir.receiver]
      }

      // ----------------------
      // ServiceMonitor 스타일 스크래핑
      // ----------------------
      discovery.relabel "service_metrics" {
        targets = discovery.kubernetes.endpoints.targets

        // prometheus.io/scrape 어노테이션이 있는 서비스만
        rule {
          source_labels = ["__meta_kubernetes_service_annotation_prometheus_io_scrape"]
          regex         = "true"
          action        = "keep"
        }

        // 스크래핑 경로 설정
        rule {
          source_labels = ["__meta_kubernetes_service_annotation_prometheus_io_path"]
          regex         = "(.+)"
          target_label  = "__metrics_path__"
        }

        // 포트 설정
        rule {
          source_labels = ["__address__", "__meta_kubernetes_service_annotation_prometheus_io_port"]
          regex         = "([^:]+)(?::\\d+)?;(\\d+)"
          replacement   = "$1:$2"
          target_label  = "__address__"
        }

        // 라벨 설정
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }

        rule {
          source_labels = ["__meta_kubernetes_service_name"]
          target_label  = "service"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
      }

      prometheus.scrape "services" {
        targets         = discovery.relabel.service_metrics.output
        scrape_interval = "60s"
        forward_to      = [prometheus.remote_write.mimir.receiver]
      }

      // ----------------------
      // Pod 어노테이션 기반 스크래핑
      // ----------------------
      discovery.relabel "pod_metrics" {
        targets = discovery.kubernetes.pod_metrics.targets

        // prometheus.io/scrape 어노테이션이 있는 Pod만
        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_prometheus_io_scrape"]
          regex         = "true"
          action        = "keep"
        }

        // 스크래핑 경로
        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_prometheus_io_path"]
          regex         = "(.+)"
          target_label  = "__metrics_path__"
        }

        // 포트 설정
        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_prometheus_io_port"]
          regex         = "([^:]+)(?::\\d+)?;(\\d+)"
          replacement   = "$1:$2"
          target_label  = "__address__"
        }

        // 라벨 설정
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_label_app"]
          target_label  = "app"
        }
      }

      prometheus.scrape "pods" {
        targets         = discovery.relabel.pod_metrics.output
        scrape_interval = "60s"
        forward_to      = [prometheus.remote_write.mimir.receiver]
      }

      // ----------------------
      // Mimir로 전송
      // ----------------------
      prometheus.remote_write "mimir" {
        endpoint {
          url = "http://lgtm-mimir-nginx.monitoring:80/api/v1/push"
        }
      }

  mounts:
    varlog: true
    dockercontainers: true

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  securityContext:
    privileged: true
    runAsUser: 0

# DaemonSet으로 배포
controller:
  type: daemonset

  tolerations:
    - operator: Exists

serviceAccount:
  create: true

rbac:
  create: true
